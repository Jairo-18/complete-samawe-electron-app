<app-base-page
  [headerTitle]="'Sistema de Facturación de Hotel'"
  [showContentTitle]="true"
  [showBackButton]="true"
  [showBorder]="false"
  backButtonRoute="/invoice/invoices/list"
  backButtonText="Volver"
  backButtonTooltip="Volver a la lista"
>
  <article class="flex flex-col md:flex-row gap-3 w-full h-full">
    <!-- Mostrar loader solo en carga inicial -->
    @if (initialLoading) {
    <div class="h-full w-full justify-center items-center flex">
      <app-loader></app-loader>
    </div>
    } @else {
    <!-- Columna izquierda -->
    <div class="flex flex-col w-full md:w-[75%] gap-3">
      <section class="flex flex-col p-4 rounded-2xl border border-[#06a606]">
        <!-- Información de la factura - aparece cuando invoiceData esté disponible -->
        @if (invoiceData) {
        <span class="text-base md:text-xl font-extrabold">
          {{ invoiceData.invoiceType.name }} Nr° {{ invoiceData.code }}
        </span>

        <section class="flex-row md:flex w-full">
          <div
            class="flex w-full md:w-[50%] justify-start text-sm md:text-base"
          >
            <span class="font-bold">
              {{
                invoiceData.invoiceType.code === 'FC'
                  ? 'Proveedor:'
                  : 'Cliente:'
              }}
              <span class="font-normal">
                {{ invoiceData.user.firstName }} {{ invoiceData.user.lastName }}
              </span>
            </span>
          </div>
          <div
            class="flex w-full md:w-[50%] justify-start md:justify-end text-sm md:text-base"
          >
            <span class="font-bold">
              Empleado:
              <span class="font-normal">
                {{ invoiceData.employee.firstName }}
                {{ invoiceData.employee.lastName }}
              </span>
            </span>
          </div>
        </section>
        }

        <!-- Tabs siempre visibles después de la carga inicial -->
        <mat-tab-group animationDuration="0ms">
          <!-- Producto: siempre disponible -->
          <mat-tab label="Producto">
            <ng-template matTabContent>
              <app-add-product
                [categoryTypes]="categoryTypes"
                [taxeTypes]="taxeTypes"
                (tempDetailAdded)="addTempProduct($event)"
              ></app-add-product>
            </ng-template>
          </mat-tab>

          <!-- Hospedaje: solo si no es FC -->

          @if (invoiceData?.invoiceType?.code !== 'FC') {
          <mat-tab label="Hospedaje">
            <ng-template matTabContent>
              <app-add-accommodation
                [categoryTypes]="categoryTypes"
                [taxeTypes]="taxeTypes"
                (tempDetailAdded)="addTempInvoiceDetail($event)"
              ></app-add-accommodation>
            </ng-template>
          </mat-tab>

          <mat-tab label="Pasadías y Servicios">
            <ng-template matTabContent>
              <app-add-excursion
                [categoryTypes]="categoryTypes"
                [taxeTypes]="taxeTypes"
                (tempDetailAdded)="addTempInvoiceDetail($event)"
              ></app-add-excursion>
            </ng-template>
          </mat-tab>
          }
        </mat-tab-group>
        <section
          class="p-2 mt-2 md:p-4 rounded-2xl border border-yellow-600"
          *ngIf="tempInvoiceDetails.length"
        >
          <span class="font-bold mb-2 block">
            Items pendientes por guardar ({{ tempInvoiceDetails.length }})
          </span>

          <div class="overflow-auto">
            <table mat-table [dataSource]="tempInvoiceDetails">
              <!-- Tipo -->
              <ng-container matColumnDef="tipo">
                <th mat-header-cell *matHeaderCellDef class="center-text">
                  Tipo
                </th>
                <td mat-cell *matCellDef="let detail">
                  {{
                    detail.productId
                      ? 'Producto'
                      : detail.accommodationId
                      ? 'Hospedaje'
                      : 'Pasadía'
                  }}
                </td>
              </ng-container>

              <!-- Cantidad -->
              <ng-container matColumnDef="amount">
                <th mat-header-cell *matHeaderCellDef class="center-text">
                  Und
                </th>
                <td mat-cell *matCellDef="let detail" class="center-text">
                  {{ detail.amount }}
                </td>
              </ng-container>

              <!-- Precio sin impuesto -->
              <ng-container matColumnDef="priceWithoutTax">
                <th mat-header-cell *matHeaderCellDef class="center-text">
                  P. sin impuesto
                </th>
                <td mat-cell *matCellDef="let detail" class="right-text">
                  {{ detail.priceWithoutTax | formatCop }}
                </td>
              </ng-container>

              <!-- Fecha entrada -->
              <ng-container matColumnDef="startDate">
                <th mat-header-cell *matHeaderCellDef class="center-text">
                  Fecha Entrada
                </th>
                <td mat-cell *matCellDef="let detail" class="center-text">
                  {{ detail.startDate | date : 'dd/MM/yyyy HH:mm' }}
                </td>
              </ng-container>

              <!-- Fecha salida -->
              <ng-container matColumnDef="endDate">
                <th mat-header-cell *matHeaderCellDef class="center-text">
                  Fecha Salida
                </th>
                <td mat-cell *matCellDef="let detail" class="center-text">
                  {{ detail.endDate | date : 'dd/MM/yyyy HH:mm' }}
                </td>
              </ng-container>

              <!-- Acciones -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="center-text">
                  Acciones
                </th>
                <td mat-cell *matCellDef="let detail" class="center-text">
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="removeTempItem(detail)"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <!-- Header y Rows -->
              <tr mat-header-row *matHeaderRowDef="tempColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: tempColumns"></tr>
            </table>
          </div>
        </section>
      </section>

      <!-- Detalle factura - aparece cuando invoiceData esté disponible -->
      <section
        class="flex flex-col p-2 md:p-4 rounded-2xl border border-[#06a606]"
      >
        <div class="w-full text-center">
          <span class="font-bold">Servicios y Productos Ingresador</span>
        </div>
        <app-invoice-detaill
          *ngIf="invoiceData"
          [invoiceDetails]="invoiceData.invoiceDetails"
          [reload]="reloadInvoiceDetails"
          (itemDelete)="onItemDelete()"
        ></app-invoice-detaill>
        <div class="w-full flex justify-end">
          <button
            class="!w-[25%] !rounded-lg"
            mat-fab
            extended="true"
            [disabled]="tempInvoiceDetails.length === 0"
            (click)="saveAllInvoiceDetails()"
          >
            Guardar items pendientes ({{ tempInvoiceDetails.length }})
          </button>
        </div>
      </section>
    </div>

    <!-- Columna derecha - aparece cuando invoiceData esté disponible -->
    <div
      class="flex flex-col w-full md:w-[25%] p-2 md:p-4 h-min rounded-2xl border border-[#06a606]"
    >
      <app-invoice-summary
        *ngIf="invoiceData"
        [invoiceData]="invoiceData"
        [paidTypes]="paidTypes"
        [payTypes]="payTypes"
        (printRequested)="printInvoice()"
        (downloadRequested)="downloadInvoice()"
      ></app-invoice-summary>
    </div>
    }
  </article>
  <app-invoice-pdf
    class="hidden"
    *ngIf="invoiceData"
    [invoiceData]="invoiceData"
    #invoiceToPrint
  ></app-invoice-pdf>
</app-base-page>
